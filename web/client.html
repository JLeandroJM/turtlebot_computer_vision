<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï PuppyBot Hunter - Monitor Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: #00ff88;
            font-size: 1.1em;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .status-label {
            font-size: 0.9em;
            color: #aaaaaa;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        .status-connected {
            color: #00ff88;
        }

        .status-disconnected {
            color: #ff4444;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #00ff88;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }

        .metric-label {
            font-size: 0.9em;
            color: #aaaaaa;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .lidar-section {
            grid-column: 1 / -1;
        }

        .lidar-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        .lidar-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .connection-info {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #00cc6a;
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .status-bar {
                flex-direction: column;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: #00ff88;
            transition: width 0.3s ease;
        }

        .alert {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêï PUPPYBOT HUNTER</h1>
            <div class="subtitle">Sistema de Persecuci√≥n Aut√≥nomo con YOLO + LiDAR</div>
            <div class="subtitle" style="font-size: 0.9em; margin-top: 10px;">
                Modelo: YOLOv8 | mAP50=83.78% | Precision=98.34% | Recall=100%
            </div>
        </header>

        <div id="connectionAlert" class="alert" style="display: none;">
            ‚ö†Ô∏è Desconectado del servidor. Intentando reconectar...
        </div>

        <div class="connection-info">
            <div style="font-size: 1.2em; margin-bottom: 10px;">
                üåê WebSocket: <span id="wsUrl">ws://localhost:8765</span>
            </div>
            <button class="btn" id="connectBtn" onclick="toggleConnection()">Conectar</button>
            <button class="btn" id="refreshBtn" onclick="location.reload()">üîÑ Refrescar</button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Estado</div>
                <div class="status-value" id="statusText">üî¥ DESCONECTADO</div>
            </div>
            <div class="status-item">
                <div class="status-label">FPS</div>
                <div class="status-value" id="fpsValue">0.0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Detecciones</div>
                <div class="status-value" id="detectionsValue">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Confianza</div>
                <div class="status-value" id="confidenceValue">0%</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="card">
                <div class="card-title">üì∑ C√°mara con Detecciones YOLO</div>
                <div class="video-container">
                    <img id="cameraImage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="C√°mara">
                    <div class="video-overlay">
                        <div>Esperando stream...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä M√©tricas en Tiempo Real</div>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">Velocidad Lineal</div>
                        <div class="metric-value" id="velocityLinear">0.00</div>
                        <div style="font-size: 0.8em; color: #aaa;">m/s</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressLinear" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="metric-box">
                        <div class="metric-label">Velocidad Angular</div>
                        <div class="metric-value" id="velocityAngular">0.00</div>
                        <div style="font-size: 0.8em; color: #aaa;">rad/s</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressAngular" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="metric-box">
                        <div class="metric-label">√Årea del Objetivo</div>
                        <div class="metric-value" id="areaFraction">0.0</div>
                        <div style="font-size: 0.8em; color: #aaa;">% del frame</div>
                    </div>

                    <div class="metric-box">
                        <div class="metric-label">Predicci√≥n</div>
                        <div class="metric-value" id="predictionStatus">‚ùå</div>
                        <div style="font-size: 0.8em; color: #aaa;" id="predictionLabel">Inactiva</div>
                    </div>
                </div>
            </div>

            <div class="card lidar-section">
                <div class="card-title">üì° Visualizaci√≥n LiDAR</div>
                <div class="lidar-container">
                    <img id="lidarImage" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="LiDAR">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">‚ÑπÔ∏è Informaci√≥n del Sistema</div>
            <div style="line-height: 1.8;">
                <div>ü§ñ <strong>Robot IP:</strong> <span id="robotIp">10.182.184.104</span></div>
                <div>üì• <strong>Puerto Im√°genes:</strong> 6000</div>
                <div>üì§ <strong>Puerto Comandos:</strong> 5007</div>
                <div>‚ö° <strong>Velocidad M√°xima:</strong> 0.5 m/s</div>
                <div>üîÑ <strong>Giro M√°ximo:</strong> 0.7 rad/s (~40¬∞/s)</div>
                <div>üéØ <strong>√Årea Objetivo:</strong> 30% del frame</div>
                <div>‚è±Ô∏è <strong>Compensaci√≥n Delay:</strong> 3.0 segundos</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let reconnectInterval = null;
        let wsUrl = 'ws://localhost:8765';

        // Intentar detectar IP local del servidor
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('ws')) {
            wsUrl = urlParams.get('ws');
            document.getElementById('wsUrl').textContent = wsUrl;
        }

        function updateUI(connected) {
            isConnected = connected;
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const alert = document.getElementById('connectionAlert');

            if (connected) {
                statusText.textContent = 'üü¢ CONECTADO';
                statusText.className = 'status-value status-connected';
                connectBtn.textContent = 'Desconectar';
                alert.style.display = 'none';
            } else {
                statusText.textContent = 'üî¥ DESCONECTADO';
                statusText.className = 'status-value status-disconnected';
                connectBtn.textContent = 'Conectar';
                alert.style.display = 'block';
            }
        }

        function connectWebSocket() {
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('‚úÖ Conectado al servidor WebSocket');
                    updateUI(true);
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'image') {
                            document.getElementById('cameraImage').src = 'data:image/jpeg;base64,' + data.data;
                        }
                        else if (data.type === 'lidar') {
                            document.getElementById('lidarImage').src = 'data:image/jpeg;base64,' + data.data;
                        }
                        else if (data.type === 'metrics') {
                            const m = data.data;
                            
                            // Actualizar m√©tricas principales
                            document.getElementById('fpsValue').textContent = m.fps.toFixed(1);
                            document.getElementById('detectionsValue').textContent = m.detections;
                            document.getElementById('confidenceValue').textContent = (m.confidence * 100).toFixed(0) + '%';
                            
                            // Velocidades
                            document.getElementById('velocityLinear').textContent = m.velocity_linear.toFixed(2);
                            document.getElementById('velocityAngular').textContent = m.velocity_angular.toFixed(2);
                            
                            // Barras de progreso (asumiendo m√°ximos de 0.5 m/s y 0.7 rad/s)
                            const linearPercent = (m.velocity_linear / 0.5) * 100;
                            const angularPercent = (Math.abs(m.velocity_angular) / 0.7) * 100;
                            document.getElementById('progressLinear').style.width = Math.min(linearPercent, 100) + '%';
                            document.getElementById('progressAngular').style.width = Math.min(angularPercent, 100) + '%';
                            
                            // √Årea
                            document.getElementById('areaFraction').textContent = (m.area_fraction * 100).toFixed(1);
                            
                            // Predicci√≥n
                            const predStatus = document.getElementById('predictionStatus');
                            const predLabel = document.getElementById('predictionLabel');
                            if (m.prediction_enabled) {
                                predStatus.textContent = '‚úÖ';
                                predLabel.textContent = 'Activa';
                            } else {
                                predStatus.textContent = '‚ùå';
                                predLabel.textContent = 'Inactiva';
                            }
                            
                            // Estado del overlay en video
                            const overlay = document.querySelector('.video-overlay');
                            if (overlay) {
                                overlay.innerHTML = `
                                    <div><strong>${m.status}</strong></div>
                                    <div style="font-size: 0.8em; margin-top: 5px;">
                                        Det: ${m.detections} | Conf: ${(m.confidence * 100).toFixed(0)}%
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        console.error('Error procesando mensaje:', e);
                    }
                };

                ws.onerror = (error) => {
                    console.error('‚ùå Error WebSocket:', error);
                    updateUI(false);
                };

                ws.onclose = () => {
                    console.log('üîå Desconectado del servidor');
                    updateUI(false);
                    
                    // Intentar reconectar autom√°ticamente
                    if (!reconnectInterval) {
                        reconnectInterval = setInterval(() => {
                            console.log('üîÑ Intentando reconectar...');
                            connectWebSocket();
                        }, 3000);
                    }
                };
            } catch (e) {
                console.error('Error creando WebSocket:', e);
                updateUI(false);
            }
        }

        function toggleConnection() {
            if (isConnected && ws) {
                ws.close();
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            } else {
                connectWebSocket();
            }
        }

        // Conectar autom√°ticamente al cargar
        window.addEventListener('load', () => {
            console.log('üöÄ Iniciando cliente web...');
            connectWebSocket();
        });

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
    </script>
</body>
</html>
